name: Build and Publish WASM
on:
  push: 
    branches: ["main"]
  release:
    types: [published]
  workflow_dispatch:    
env:
  PLATFORM: PLATFORM_WEB
  MAKE: /usr/bin/make
  PYTHON_PATH: /usr/bin
  GITHUB_SHA: ${{ github.sha }}
  REPO: ${{ github.repository }}  
jobs:
  make-gh-pages:
    name: Create gh-pages branch if necessary
    runs-on: ubuntu-latest
    steps:
      - name: Create gh-pages branch
        uses: peterjgrainger/action-create-branch@v2.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          branch: 'gh-pages'
  build:
    name: Build WASM for Merge
    needs: [make-gh-pages]    
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y make build-essential python3 curl
      - name: Get nightly raylib wasm build
        run: mkdir -p $GITHUB_WORKSPACE/raylib && curl -o - https://michaelfiber.github.io/raylib-nightly-wasm/libraylib.a.gz | gunzip > $GITHUB_WORKSPACE/raylib/libraylib.a
      - name: Checkout raylib-game-template
        uses: actions/checkout@v3
        with:
          path: raylib-game-template
      - name: Checkout emsdk
        uses: mymindstorm/setup-emsdk@v11
      - name: Compile raylib-game-template for WASM
        run: $GITHUB_WORKSPACE/raylib-game-template/github-scripts/compile-raylib-game-template.sh
      - name: Zip release artifacts
        run: $GITHUB_WORKSPACE/raylib-game-template/github-scripts/create-release-zip.sh
      - name: Deploy Static Site
        uses: moodiest/push-to-branch-action@develop
        env:
          REPO: self
          BRANCH: gh-pages
          FOLDER: raylib-game-template/site
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}